---
title : "Confinements et surmortalité masculine"

output:
  bookdown::pdf_document2:
    keep_tex: yes 
    latex_engine: lualatex
    toc: no

mainfont: "Times New Roman"
fontsize: 12pt

header-includes:
  - \usepackage[french]{babel}
  - \addto\captionsfrench{\renewcommand{\tablename}{Tableau}}
  # - \usepackage[utf8]{inputenc}
  # - \usepackage{setspace}
  - \usepackage{float}
  - \usepackage{geometry}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{threeparttable}
  - \appto\TPTnoteSettings{\linespread{1}\footnotesize}
  # - \usepackage{threeparttablex}
  # - \usepackage{multirow}
  # - \usepackage{array}
  - \setcounter{secnumdepth}{0}
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = 'center', fig.height = 5, fig.width = 8)

pacman::p_load(data.table, magrittr, ggplot2, ggpubr, kableExtra)
theme_set(theme_minimal())
year_colours <- viridis::magma(2, begin = 0.3, end = 0.7)

# On conserve les 18-29 ans et on enlève le 29 février 2020
deces <- fread("../Data/deces_2018-2022.csv")[ADEC %in% 2018:2020 & 
                                             age >= 18 & age < 30 & 
                                             date_dec != "2020-02-29"]

# Codage des périodes 
# 1 : 1er janvier - 16 mars
# 2 : 17 mars - 11 mai (premier confinement)
# 3 : 12 mai - 29 octobre
# 4 : 30 octobre - 15 décembre (deuxième confinement)
# 5 : 16 décembre - 31 décembre

deces[, md_dec := format(date_dec, "%m-%d")]
deces[, periode := fcase(md_dec >= "01-01" & md_dec <= "03-16", 1,
                                md_dec >= "03-17" & md_dec <= "05-11", 2,
                                md_dec >= "05-12" & md_dec <= "10-29", 3,
                                md_dec >= "10-30" & md_dec <= "12-16", 4,
                                md_dec >= "12-17" & md_dec <= "12-31", 5)]
labs_per <- c("1 jan - 16 mar", "17 mar - 11 mai", "12 mai - 29 oct",
              "30 oct - 15 déc", "16 déc - 31 déc")
labs_per_long <- c("1 janvier - 16 mars", "17 mars - 11 mai", "12 mai - 29 octobre",
              "30 octobre - 15 décembre", "16 décembre - 31 décembre")

# Nombre de décès par périodes et années
tab_dec <- deces[, .(ndec = .N), keyby = .(periode, ADEC)]
# dcast(tab_dec, ADEC ~ factor(periode, labels = labs_per), value.var = "ndec")

# Nombre de décès par périodes, années et sexe
tab_dec_sexe <- deces[, .(ndec = .N), keyby = .(periode, ADEC, SEXE)]
# dcast(tab_dec_sexe, ADEC + SEXE ~ factor(periode, labels = labs_per), value.var = "ndec")


# Fonction pour différences de différences années/périodes
diffdediff <- function(tab_dec, annees, periodes) {

  dd <- diff(tab_dec[periode %in% periodes & ADEC %in% annees, 
                     .(d = diff(ndec)), keyby = ADEC]$d)
  expected <- tab_dec[periode == periodes[2] & ADEC == annees[2], ndec] - dd
  
  tab <- rbind(dcast(tab_dec[periode %in% periodes & ADEC %in% annees], 
                     factor(periode, labels = labs_per_long[periodes]) ~ ADEC, 
                     value.var = "ndec"),
               list("Attendu sans confinement", "", expected),
               list("Nombre de vies « sauvées »", "", -dd),
               list("Réduction de la mortalité", "", paste0(round(100*dd/expected), "%")))
  
  return(list("tab" = tab, "dd" = dd, "expected" = expected))
}
```

## Comparaison des courbes de mortalité des jeunes entre 2018 et 2019 (conditions d'application de la différence de différences)

```{r comp-annees, fig.cap="Nombre de décès chez les 18-29 ans en 2018 et 2019 en fonction de la période", fig.width=10, fig.height = 4}

plots <- lapply(list(c(1,2), c(1,4), c(3,4)),
                function(periodes) {
                  ggplot(tab_dec[ADEC %in% 2018:2019 & periode %in% periodes]) +
                    geom_line(aes(x = factor(periode, labels = labs_per[periodes]),
                                  y = ndec,
                                  group = factor(ADEC), 
                                  colour = factor(ADEC))) +
                    scale_colour_manual("", values = viridis::viridis(2, begin = 0.2, end = 0.8)) +
                    labs(x = "", y = "")
                })

ggarrange(plotlist = plots, common.legend = T, nrow = 1)

```

```{r comp-annees-moy, fig.cap="Nombre moyen de décès journaliers chez les 18-29 ans en 2018 et 2019 en fonction de la période", fig.width=10, fig.height = 4}

plots <- lapply(list(c(1,2), c(1,4), c(3,4)),
                function(periodes) {
                  ggplot(tab_dec[data.table(periode = 1:5, 
                                                 njours = c(75, 56, 171, 48, 15)),
                                      .(periode, ADEC, moydec = ndec/njours), 
                                      on = "periode"
                                      ][ADEC %in% 2018:2019 & periode %in% periodes]) +
                    geom_line(aes(x = factor(periode, labels = labs_per[periodes]),
                                  y = moydec,
                                  group = factor(ADEC),
                                  colour = factor(ADEC))) +
                    scale_colour_manual("", values = viridis::viridis(2, begin = 0.2, end = 0.8)) +
                    labs(x = "", y = "")
                })

ggarrange(plotlist = plots, common.legend = T, nrow = 1)
```

\newpage
```{r comp-annees-sexe, fig.cap="Nombre de décès chez les 18-29 ans en 2018 et 2019 en fonction de la période et du sexe", fig.width=10, fig.height = 4}

plots <- lapply(list(c(1,2), c(1,4), c(3,4)),
                function(periodes) {
                  ggplot(tab_dec_sexe[ADEC %in% 2018:2019 & periode %in% periodes]) +
                    geom_line(aes(x = factor(periode, labels = labs_per[periodes]),
                                  y = ndec,
                                  group = interaction(factor(ADEC), factor(SEXE)), 
                                  colour = factor(ADEC),
                                  linetype = factor(SEXE, labels = c("Femmes", "Hommes")))) +
                    scale_colour_manual("", values = viridis::viridis(2, begin = 0.2, end = 0.8)) +
                    scale_linetype_manual("", values = c("longdash", "solid")) +
                    labs(x = "", y = "")
                })

ggarrange(plotlist = plots, common.legend = T, nrow = 1)

```

```{r comp-annees-moy-sexe, fig.cap="Nombre moyen de décès journaliers chez les 18-29 ans en 2018 et 2019 en fonction de la période et du sexe", fig.width=10, fig.height = 4}

plots <- lapply(list(c(1,2), c(1,4), c(3,4)),
                function(periodes) {
                  ggplot(tab_dec_sexe[data.table(periode = 1:5, 
                                                 njours = c(75, 56, 171, 48, 15)),
                                      .(periode, ADEC, SEXE, moydec = ndec/njours), 
                                      on = "periode"
                                      ][ADEC %in% 2018:2019 & periode %in% periodes]) +
                    geom_line(aes(x = factor(periode, labels = labs_per[periodes]),
                                  y = moydec,
                                  group = interaction(factor(ADEC), factor(SEXE)), 
                                  colour = factor(ADEC),
                              linetype = factor(SEXE, labels = c("Femmes", "Hommes")))) +
                    scale_colour_manual("", values = viridis::viridis(2, begin = 0.2, end = 0.8)) +
                    scale_linetype_manual("", values = c("longdash", "solid")) +
                    labs(x = "", y = "")
                })

ggarrange(plotlist = plots, common.legend = T, nrow = 1)
```


\newpage
## Effet du premier confinement sur la mortalité des jeunes (18-29 ans)

```{r conf-tab}
merge(diffdediff(tab_dec, c(2018, 2020), c(1,2))$tab,
      diffdediff(tab_dec, c(2019, 2020), c(1,2))$tab, by = "periode"
      )[, setnames(.SD, c(" ", "2018", "2020", "2019", "2020"))] %>%
  kbl(booktabs = T, format = "latex", align = "lrrrr",
      caption = "Nombre de décès chez les 18-29 ans : différence de différences pour estimer l'effet du premier confinement") %>%
      kable_styling(position ="center", latex_options = "HOLD_position") %>%
  row_spec(2, hline_after = T) %>%
  add_header_above(c(" ", "Contrôle 2018" = 2, "Contrôle 2019" = 2))
```

```{r conf-plot, fig.cap="Nombre de décès des 18-29 ans en fonction de l'année et de la période"}
plots <- lapply(2018:2019, function(an) {
  ggplot() +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,2)]),
                  y = ndec, group = ADEC, colour = factor(ADEC)),
              data = tab_dec[periode %in% c(1,2) & ADEC %in% c(an, 2020)]) +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,2)]), y = ndec, group = 1),
              data = data.table(periode = c(1,2),
                                ndec = c(tab_dec[periode == 1 & ADEC == 2020, ndec], 
                                         diffdediff(tab_dec, c(an, 2020), c(1,2))$expected)),
              linetype = "dashed", colour = year_colours[2]) +
    scale_colour_manual("", values = year_colours) +
    labs(x = "", y = "") +
    theme(legend.position = "top")
})

ggarrange(plotlist = plots) %>%
  annotate_figure(left = text_grob("Nombre de décès", size = 10, rot = 90),
                  bottom = text_grob("Période", size = 10))
```


## Effet du deuxième confinement sur la mortalité des jeunes (18-29 ans)

```{r reconf-tab}
merge(diffdediff(tab_dec, c(2018, 2020), c(1,4))$tab,
      diffdediff(tab_dec, c(2019, 2020), c(1,4))$tab, by = "periode"
      )[, setnames(.SD, c(" ", "2018", "2020", "2019", "2020"))] %>%
  kbl(booktabs = T, format = "latex", align = "lrrrr",
      caption = "Nombre de décès chez les 18-29 ans : différence de différences pour estimer l'effet du deuxième confinement") %>%
      kable_styling(position ="center", latex_options = "HOLD_position") %>%
  row_spec(2, hline_after = T) %>%
  add_header_above(c(" ", "Contrôle 2018" = 2, "Contrôle 2019" = 2))
```

```{r reconf-plot, fig.cap="Nombre de décès dès 18-29 ans en fonction de l'année et de la période"}
plots <- lapply(2018:2019, function(an) {
  ggplot() +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,4)]),
                  y = ndec, group = ADEC, colour = factor(ADEC)),
              data = tab_dec[periode %in% c(1,4) & ADEC %in% c(an, 2020)]) +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,4)]), y = ndec, group = 1),
              data = data.table(periode = c(1,4),
                                ndec = c(tab_dec[periode == 1 & ADEC == 2020, ndec], 
                                         diffdediff(tab_dec, c(an, 2020), c(1,4))$expected)),
              linetype = "dashed", colour = year_colours[2]) +
    scale_colour_manual("", values = year_colours) +
    labs(x = "", y = "") +
    theme(legend.position = "top")
})

ggarrange(plotlist = plots) %>%
  annotate_figure(left = text_grob("Nombre de décès", size = 10, rot = 90),
                  bottom = text_grob("Période", size = 10))
```


## Effet du deuxième confinement sur la mortalité des jeunes (18-29 ans) : entre-deux-confinements comme période de pré-traitement

```{r reconf-per3-tab}
merge(diffdediff(tab_dec, c(2018, 2020), c(3,4))$tab,
      diffdediff(tab_dec, c(2019, 2020), c(3,4))$tab, by = "periode"
      )[, setnames(.SD, c(" ", "2018", "2020", "2019", "2020"))] %>%
  kbl(booktabs = T, format = "latex", align = "lrrrr",
      caption = "Nombre de décès chez les 18-29 ans : différence de différences pour estimer l'effet du deuxième confinement") %>%
      kable_styling(position ="center", latex_options = "HOLD_position") %>%
  row_spec(2, hline_after = T) %>%
  add_header_above(c(" ", "Contrôle 2018" = 2, "Contrôle 2019" = 2))
```

```{r reconf-per3-plot, fig.cap="Nombre de décès dès 18-29 ans en fonction de l'année et de la période"}
plots <- lapply(2018:2019, function(an) {
  ggplot() +
    geom_line(aes(x = factor(periode, labels = labs_per[c(3,4)]),
                  y = ndec, group = ADEC, colour = factor(ADEC)),
              data = tab_dec[periode %in% c(3,4) & ADEC %in% c(an, 2020)]) +
    geom_line(aes(x = factor(periode, labels = labs_per[c(3,4)]), y = ndec, group = 1),
              data = data.table(periode = c(3,4),
                                ndec = c(tab_dec[periode == 3 & ADEC == 2020, ndec], 
                                         diffdediff(tab_dec, c(an, 2020), c(3,4))$expected)),
              linetype = "dashed", colour = year_colours[2]) +
    scale_colour_manual("", values = year_colours) +
    labs(x = "", y = "") +
    theme(legend.position = "top")
})

ggarrange(plotlist = plots) %>%
  annotate_figure(left = text_grob("Nombre de décès", size = 10, rot = 90),
                  bottom = text_grob("Période", size = 10))
```



## Effet différencié du premier confinement chez les jeunes femmes et les jeunes hommes

```{r conf-sexe-tab}
dds2018 <- lapply(c("Femmes" = "F", "Hommes" = "M"),
                  function(sexe) diffdediff(tab_dec_sexe[SEXE == sexe], 
                                            c(2018,2020), c(1,2)))

dds2019 <- lapply(c("Femmes" = "F", "Hommes" = "M"),
              function(sexe) diffdediff(tab_dec_sexe[SEXE == sexe], 
                                        c(2019,2020), c(1,2)))

rbind(Reduce(function(x,y) merge(x,y, by = "periode"), 
             list(dds2018$Femmes$tab, dds2018$Hommes$tab, 
                  dds2019$Femmes$tab, dds2019$Hommes$tab)),
      list("Vies « sauvées » hommes vs. femmes", 
           "", "", "", dds2018$Femmes$dd - dds2018$Hommes$dd, 
           "", "", "", dds2019$Femmes$dd - dds2019$Hommes$dd)
      )[, setnames(.SD, c(" ", rep(c("2018", "2020"), 2), 
                           rep(c("2019", "2020"), 2)))] %>%
  kbl(booktabs = T, format = "latex", align = "lrrrrrrrr", linesep = "",
      caption = "Nombre de décès chez les 18-29 ans : triple différence pour estimer l'effet du premier confinement selon le sexe") %>%
  kable_styling(position ="center", latex_options = "HOLD_position") %>%
  row_spec(c(2, 5), hline_after = T) %>%
  add_header_above(c(" ", "Femmes" = 2, "Hommes" = 2, "Femmes" = 2, "Hommes" = 2)) %>%
  add_header_above(c(" ", "Contrôle 2018" = 4, "Contrôle 2019" = 4))
```


```{r conf-sexe-plot, fig.cap="Nombre de décès des 18-29 ans en fonction de l'année, de la période, et du sexe"}

plots <- lapply(2018:2019, function(an) {
  ggplot() +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,2)]),
                  y = ndec, group = interaction(ADEC, SEXE), 
                  colour = factor(ADEC)),
              data = tab_dec_sexe[periode %in% c(1,2) & ADEC %in% c(an, 2020)]) +
    geom_line(aes(x = factor(periode, labels = labs_per[c(1,2)]), y = ndec, group = SEXE),
              data = data.table(periode = c(1,2,1,2), SEXE = c("F", "F", "M", "M"),
                                ndec = c(tab_dec_sexe[periode == 1 & ADEC == 2020 & SEXE == "F", ndec], 
                                         diffdediff(tab_dec_sexe[SEXE == "F"], c(an, 2020), c(1,2))$expected,
                                         tab_dec_sexe[periode == 1 & ADEC == 2020 & SEXE == "M", ndec], 
                                         diffdediff(tab_dec_sexe[SEXE == "M"], c(an, 2020), c(1,2))$expected)),
              linetype = "dashed", colour = year_colours[2]) +
    #facet_wrap(~factor(SEXE)) +
    scale_colour_manual("", values = year_colours) +
    labs(x = "", y = "") +
    theme(legend.position = "top") +
    geom_label(aes(label = factor(SEXE, labels = c("Femmes", "Hommes")), 
                   x = periode, y = ndec),
               label.size = NA, size = 2.5, nudge_y = 25,
               data = tab_dec_sexe[periode == 1 & ADEC == 2020])
})

ggarrange(plotlist = plots) %>%
  annotate_figure(left = text_grob("Nombre de décès", size = 10, rot = 90),
                  bottom = text_grob("Période", size = 10))

```
\newpage
## Questions

- Est-ce qu'on reste en nombre de morts ou est-ce qu'il vaut mieux passer en taux ?
- Dans son fil twitter O. Godechot a des tests de significativité sur ses estimateurs pour les hommes et les femmes, à quoi est-ce qu'ils correspondent ? Est-ce que c'est lié à l'utilisation d'une moyenne sur deux ans ?





